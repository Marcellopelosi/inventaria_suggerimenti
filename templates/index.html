<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proposta Generata</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }

    body {
      display: flex;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      text-align: center;
      font-size: clamp(1.8rem, 2.5vw, 2.5rem);
      color: #2d3748;
      margin-bottom: 20px;
    }

    .grid-2x3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .image-card, .table-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-card h3, .table-card h3 {
      margin-bottom: 10px;
      font-size: 1.1em;
      color: #4a5568;
      text-align: center;
    }

    .image-card img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      background-color: #f8fafc;
    }

    .proposal-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-size: 0.9em;
    }

    .proposal-table th {
      background: #4a5568;
      color: white;
      padding: 6px;
      font-weight: 600;
    }

    .proposal-table td {
      padding: 8px;
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .sustainability-3 { background-color: #c6f6d5 !important; }
    .sustainability-2 { background-color: #fed7aa !important; }
    .sustainability-1 { background-color: #fecaca !important; }

    .product-image {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
    }

    .stars {
      color: #fbbf24;
    }

    .button-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .btn {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .btn-red {
      background-color: #e53e3e;
      color: white;
    }

    .btn-red:hover {
      background-color: #c53030;
    }

    .btn-green {
      background-color: #38a169;
      color: white;
    }

    .btn-green:hover {
      background-color: #2f855a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Riepilogo della selezione e alternative ecologicheðŸŒ±</h1>

    <section class="grid-2x3">
      <div class="image-card">
        <h3>Il tuo Capo</h3>
        <img src="{{ feedback_photo_url }}" alt="User Feedback Photo"
             onerror="this.onerror=null;this.src='{{ placeholder_image_url }}';">
      </div>

      <div class="image-card">
        <h3>Proposta alternativa nÂ°1</h3>
        <img src="{{ generated_image_1_url }}" alt="Generated Proposal 1">
      </div>

      <div class="image-card">
        <h3>Proposta alternativa nÂ°2</h3>
        <img src="{{ generated_image_2_url }}" alt="Generated Proposal 2">
      </div>

      <div class="table-card">
        <h3>Le tue selezioni</h3>
        <div id="table-1-container"></div>
      </div>

      <div class="table-card">
        <h3>Selezione alternativa nÂ°1</h3>
        <div id="table-2-container"></div>
      </div>

      <div class="table-card">
        <h3>Selezione alternativa nÂ°2</h3>
        <div id="table-3-container"></div>
      </div>
    </section>

    <div class="button-row">
      <button class="btn btn-red" onclick="location.href='success.html'">Procedi</button>
      <button class="btn btn-green" onclick="location.href='success.html'">Procedi</button>
      <button class="btn btn-green" onclick="location.href='success.html'">Procedi</button>
    </div>
  </div>

  <script>
    function generateStars(sustainabilityValue) {
      return `<span class="stars">${'â˜…'.repeat(sustainabilityValue)}</span>`;
    }

    function getSustainabilityClass(sustainabilityValue) {
      return `sustainability-${sustainabilityValue}`;
    }

    function processTableData(tableHtml, containerId) {
      const container = document.getElementById(containerId);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = tableHtml;

      const originalTable = tempDiv.querySelector('table');
      if (!originalTable) return;

      const newTable = document.createElement('table');
      newTable.className = 'proposal-table';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const headers = ['Materia Prima', 'Immagine', 'SostenibilitÃ '];
      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      newTable.appendChild(thead);

      const tbody = document.createElement('tbody');
      originalTable.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
          let name = '', photoUrl = '', sustainability = 1;

          for (let i = 0; i < cells.length; i++) {
            const text = cells[i].textContent.trim();
            if (text.includes('http') || /\.(jpg|jpeg|png)/i.test(text)) photoUrl = text;
            else if (['1', '2', '3'].includes(text)) sustainability = parseInt(text);
            else if (!name) name = text;
          }

          const tr = document.createElement('tr');
          tr.className = getSustainabilityClass(sustainability);

          const nameTd = document.createElement('td');
          nameTd.textContent = name || 'N/A';

          const imageTd = document.createElement('td');
          imageTd.innerHTML = `<img src="${photoUrl || 'https://via.placeholder.com/60x60/cccccc/ffffff?text=No+Image'}" 
                               alt="${name}" class="product-image">`;

          const susTd = document.createElement('td');
          susTd.innerHTML = generateStars(sustainability);

          [nameTd, imageTd, susTd].forEach(td => tr.appendChild(td));
          tbody.appendChild(tr);
        }
      });

      newTable.appendChild(tbody);
      container.appendChild(newTable);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const table1Html = `{{ table_1_html | safe }}`;
      const table2Html = `{{ table_2_html | safe }}`;
      const table3Html = `{{ table_3_html | safe }}`;

      if (table1Html) processTableData(table1Html, 'table-1-container');
      if (table2Html) processTableData(table2Html, 'table-2-container');
      if (table3Html) processTableData(table3Html, 'table-3-container');
    });
  </script>
</body>
</html>
